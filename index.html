<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤§é€ƒæ€ç›‘æ§å®¤</title>
    <script src="data.js"></script>
    <style>
        /* --- ğŸŒ‘ èµ›åš/ç›‘æ§å®¤é£æ ¼ --- */
        :root {
            --bg: #050505;
            --grid-line: #1f1f1f;
            --room-bg: #0f0f0f;
            --gold: #f0c05a;
            --red: #ff3333;
            --neon-red: 0 0 10px rgba(255, 50, 50, 0.8);
            --text: #a0a0a0;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', 'Roboto Mono', monospace;
            margin: 0; padding: 10px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
        }

        h1 { margin: 10px 0 5px 0; font-size: 20px; color: #fff; letter-spacing: 2px; text-transform: uppercase; }
        .subtitle { font-size: 10px; color: #555; margin-bottom: 20px; }

        /* --- åˆ—è¡¨ --- */
        .history-list { width: 100%; max-width: 400px; padding-bottom: 50px; }
        .match-card {
            background: #111; border: 1px solid #333;
            margin-bottom: 8px; padding: 10px; display: flex; align-items: center; 
            cursor: pointer; transition: 0.2s;
        }
        .match-card:hover { border-color: var(--gold); background: #1a1a1a; }
        .match-card .info { font-size: 13px; color: #fff; font-weight: bold; }
        .match-card .type-icon { margin-left: 5px; font-size: 10px; background: #333; padding: 2px 4px; border-radius: 3px; }

        /* --- ğŸ“º ç›‘æ§ä¸»å± --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100; flex-direction: column; align-items: center; justify-content: center; }
        
        .screen-header { 
            width: 100%; max-width: 400px; display: flex; justify-content: space-between; 
            padding: 10px; box-sizing: border-box; color: var(--gold); font-size: 12px; border-bottom: 1px solid #333; margin-bottom: 20px;
        }

        /* --- ğŸ° åœ°å›¾è®¾è®¡ --- */
        .map-wrapper { position: relative; width: 340px; height: 340px; }
        
        .mansion-grid {
            display: grid; grid-template-columns: repeat(3, 1fr);
            width: 100%; height: 100%;
            gap: 2px; background: #333; border: 2px solid #444;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        .room-cell {
            background: var(--room-bg);
            position: relative; display: flex; flex-wrap: wrap; 
            align-items: center; justify-content: center;
            overflow: hidden; transition: background 0.3s;
        }
        
        /* æˆ¿é—´è¢«æ‰«æ/é€‰ä¸­æ—¶çš„æ•ˆæœ */
        .room-cell.target-lock { background: #1a0505; box-shadow: inset 0 0 20px var(--red); border: 1px solid var(--red); }
        .room-cell.blood-bath { background: #500 !important; transition: 0.1s; }

        .room-id { position: absolute; top: 2px; left: 4px; font-size: 8px; color: #333; font-family: sans-serif; }

        /* ç©å®¶å¤´åƒ */
        .player-dot {
            width: 28px; height: 28px; background: #222; color: #fff;
            border: 1px solid #555; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: bold; margin: 2px;
            z-index: 10; transition: 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .player-dot.survivor { border-color: var(--gold); color: var(--gold); }
        .player-dot.dead { background: #111; color: #333; border-color: #333; text-decoration: line-through; transform: scale(0.8); }

        /* ğŸ‘¹ è¿½çŒè€… */
        .hunter {
            position: absolute; width: 40px; height: 40px;
            background: radial-gradient(circle, var(--red) 0%, transparent 70%);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; z-index: 99;
            transition: top 0.4s linear, left 0.4s linear; /* çº¿æ€§ç§»åŠ¨é…åˆJS */
            filter: drop-shadow(var(--neon-red));
            pointer-events: none;
        }

        /* --- æ§åˆ¶å° --- */
        .console-log {
            width: 340px; height: 60px; margin-top: 15px;
            background: #0a0a0a; border: 1px solid #333;
            font-family: monospace; font-size: 10px; color: #0f0;
            padding: 5px; overflow: hidden; display: flex; align-items: center; justify-content: center;
            text-align: center;
        }

        .action-btn {
            margin-top: 20px;
            background: var(--red); color: #fff; border: none;
            padding: 12px 40px; font-size: 14px; font-weight: bold; letter-spacing: 2px;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            cursor: pointer; box-shadow: var(--neon-red);
            transition: 0.2s;
        }
        .action-btn:active { transform: scale(0.95); }
        .action-btn.hidden { display: none; }

        /* --- è½®ç›˜å…¼å®¹æ ·å¼ --- */
        .wheel-area { display: none; width: 100%; height: 150px; background: #111; border: 1px solid var(--gold); position:relative; overflow:hidden;}
        .strip { display:flex; height:100%; position:absolute; left:50%; }
        .wheel-item { width:90px; height:100%; background:#222; border-right:1px solid #000; display:flex; align-items:center; justify-content:center; }
        
        /* ç»“ç®— */
        .winner-overlay { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); flex-direction: column; align-items: center; justify-content: center; z-index: 200; animation: fadeIn 1s;}
        
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    </style>
</head>
<body>

    <h1>å¤§é€ƒæ€ç›‘æ§å®¤</h1>
    <div class="subtitle">AUTOMATED BATTLE ROYALE SYSTEM</div>

    <div class="history-list" id="listArea"></div>

    <div class="modal" id="gameModal">
        <div class="screen-header">
            <div id="gameIdDisplay">ID: 000</div>
            <div id="statusTag">STANDBY</div>
        </div>

        <!-- åœ°å›¾æ¨¡å¼ -->
        <div class="map-wrapper" id="mapWrapper">
            <div class="mansion-grid" id="grid"></div>
            <div class="hunter" id="hunter" style="display:none">ğŸ‘¹</div>
        </div>

        <!-- è½¬ç›˜æ¨¡å¼(å…¼å®¹) -->
        <div class="wheel-area" id="wheelWrapper">
            <div style="position:absolute;left:50%;top:0;height:100%;width:2px;background:var(--gold);z-index:10;transform:translateX(-50%)"></div>
            <div class="strip" id="wheelStrip"></div>
        </div>

        <div class="console-log" id="consoleText">ç­‰å¾…ç³»ç»Ÿå¯åŠ¨...</div>

        <button class="action-btn" id="startBtn" onclick="startAutoSequence()">START MASSACRE</button>
        <button onclick="closeGame()" style="background:transparent;border:1px solid #333;color:#555;margin-top:20px;padding:5px 20px;cursor:pointer">EXIT</button>

        <div class="winner-overlay" id="winScreen">
            <div style="font-size:50px">ğŸ†</div>
            <div style="color:var(--gold);font-size:20px;font-weight:bold;margin-top:10px" id="wName"></div>
            <div style="color:#666;font-size:12px;margin-top:5px" id="wPrize"></div>
            <button onclick="closeGame()" style="margin-top:20px;background:#333;color:#fff;border:none;padding:10px 30px">CLOSE</button>
        </div>
    </div>

    <script>
        // éŸ³æ•ˆ
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function sfx(t) {
            if(audioCtx.state==='suspended') audioCtx.resume();
            const osc=audioCtx.createOscillator(), g=audioCtx.createGain();
            const now=audioCtx.currentTime;
            if(t==='step'){
                osc.type='triangle'; osc.frequency.setValueAtTime(100,now); osc.frequency.exponentialRampToValueAtTime(50,now+0.1);
                g.gain.setValueAtTime(0.1,now); g.gain.exponentialRampToValueAtTime(0.01,now+0.1);
                osc.start(now); osc.stop(now+0.1);
            } else if(t==='kill'){
                osc.type='sawtooth'; osc.frequency.setValueAtTime(100,now); osc.frequency.exponentialRampToValueAtTime(10,now+0.3);
                g.gain.setValueAtTime(0.5,now); g.gain.exponentialRampToValueAtTime(0.01,now+0.3);
                osc.start(now); osc.stop(now+0.3);
            } else if(t==='win'){
                osc.type='sine'; osc.frequency.setValueAtTime(440,now); 
                g.gain.setValueAtTime(0.2,now); g.gain.exponentialRampToValueAtTime(0.01,now+1);
                osc.start(now); osc.stop(now+1);
            }
            osc.connect(g); g.connect(audioCtx.destination);
        }
        function wait(ms){return new Promise(r=>setTimeout(r,ms))}

        // æ ¸å¿ƒå˜é‡
        let currentGame = null;
        let hunterPos = -1; // å± å¤«å½“å‰çš„æ ¼å­ç´¢å¼• 0-8

        // 1. åˆ—è¡¨æ¸²æŸ“
        const listArea = document.getElementById('listArea');
        if(typeof gameHistory !== 'undefined') {
            gameHistory.slice().reverse().forEach(g => {
                const div = document.createElement('div');
                div.className = 'match-card';
                div.onclick = () => loadGame(g);
                const isMap = g.type === 'map';
                div.innerHTML = `
                    <div style="flex:1">
                        <span class="info">${g.id}</span>
                        ${isMap ? '<span class="type-icon">MAP</span>' : ''}
                        <div style="color:#666;font-size:10px;margin-top:2px">${g.prize}</div>
                    </div>
                `;
                listArea.appendChild(div);
            });
        }

        // 2. åŠ è½½æ¸¸æˆ
        function loadGame(game) {
            currentGame = game;
            document.getElementById('gameModal').style.display = 'flex';
            document.getElementById('winScreen').style.display = 'none';
            document.getElementById('gameIdDisplay').innerText = game.id;
            document.getElementById('consoleText').innerText = "SYSTEM READY. AWAITING START.";
            document.getElementById('startBtn').classList.remove('hidden');

            // æ¨¡å¼åˆ‡æ¢
            if (game.type === 'map') {
                document.getElementById('mapWrapper').style.display = 'block';
                document.getElementById('wheelWrapper').style.display = 'none';
                initMap(game);
            } else {
                document.getElementById('mapWrapper').style.display = 'none';
                document.getElementById('wheelWrapper').style.display = 'block';
                initWheel(game);
            }
        }

        function closeGame() { document.getElementById('gameModal').style.display = 'none'; }

        // --- åœ°å›¾æ¨¡å¼æ ¸å¿ƒé€»è¾‘ ---

        function initMap(game) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            
            // ç”Ÿæˆ9ä¸ªæˆ¿é—´
            for(let i=0; i<9; i++) {
                const cell = document.createElement('div');
                cell.className = 'room-cell';
                cell.id = `cell-${i}`;
                cell.innerHTML = `<div class="room-id">R-${i+1}</div>`;
                grid.appendChild(cell);
            }

            // æ”¾ç½®ç©å®¶
            game.players.forEach((name, idx) => {
                const roomIdx = game.rooms[idx];
                const cell = document.getElementById(`cell-${roomIdx}`);
                const dot = document.createElement('div');
                dot.className = 'player-dot';
                dot.id = `p-${idx}`;
                dot.innerText = name.substring(0,1); // åªæ˜¾ç¤ºé¦–å­—
                dot.title = name;
                cell.appendChild(dot);
            });

            // åˆå§‹åŒ–å± å¤«ä½ç½® (éšè—)
            const hunter = document.getElementById('hunter');
            hunter.style.display = 'none';
            hunterPos = -1; 
        }

        // è‡ªåŠ¨è¿æ’­ä¸»å¾ªç¯
        async function startAutoSequence() {
            if(currentGame.type !== 'map') { playWheelSequence(); return; }

            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('statusTag').innerText = "SEQUENCE RUNNING";
            
            // å± å¤«åˆå§‹å…¥åœº (éšæœºä¸€ä¸ªç©ºé™ç‚¹ï¼Œæˆ–è€…ä» 4 å·ä½ä¸­é—´å‡ºæ¥)
            hunterPos = 4;
            updateHunterVis(4); 
            document.getElementById('hunter').style.display = 'flex';
            log("âš  è­¦å‘Šï¼šè¿½çŒè€…å·²è¿›å…¥è®¾æ–½");
            await wait(1500);

            // å¾ªç¯å¤„å†³åå•
            for (let i = 0; i < currentGame.outSequence.length; i++) {
                const victimIdx = currentGame.outSequence[i];
                const victimRoom = currentGame.rooms[victimIdx];
                const victimName = currentGame.players[victimIdx];

                log(`æ­£åœ¨æœå¯»ç›®æ ‡: ${victimName}...`);
                
                // 1. å¯»è·¯å¹¶ç§»åŠ¨
                await moveHunterTo(victimRoom);

                // 2. æ€æˆ®ç‰¹æ•ˆ
                log(`>> ç›®æ ‡é”å®š [${victimName}] <<`);
                sfx('kill');
                const cell = document.getElementById(`cell-${victimRoom}`);
                cell.classList.add('blood-bath');
                const pDot = document.getElementById(`p-${victimIdx}`);
                if(pDot) pDot.classList.add('dead');

                if(navigator.vibrate) navigator.vibrate(200);
                await wait(800);
                cell.classList.remove('blood-bath');
                
                log(`${victimName} å·²ç¡®è®¤æ­»äº¡ã€‚`);
                await wait(1000); // åœé¡¿ä¸€ä¸‹å†æ‰¾ä¸‹ä¸€ä¸ª
            }

            // ç»“æŸ
            showMapWinner();
        }

        // BFS å¯»è·¯ç®—æ³• (3x3 ç½‘æ ¼)
        // 0 1 2
        // 3 4 5
        // 6 7 8
        function getPath(start, end) {
            if (start === end) return [start];
            const adj = [
                [1,3], [0,2,4], [1,5],
                [0,4,6], [1,3,5,7], [2,4,8],
                [3,7], [4,6,8], [5,7]
            ];
            let queue = [[start]];
            let visited = new Set([start]);
            
            while(queue.length > 0) {
                let path = queue.shift();
                let node = path[path.length-1];
                if (node === end) return path;
                
                for(let neighbor of adj[node]) {
                    if(!visited.has(neighbor)) {
                        visited.add(neighbor);
                        let newPath = [...path, neighbor];
                        queue.push(newPath);
                    }
                }
            }
            return [end]; // fallback
        }

        // ç§»åŠ¨åŠ¨ç”»
        async function moveHunterTo(targetRoom) {
            const path = getPath(hunterPos, targetRoom);
            // path æ˜¯ [start, next, next, end]
            // æˆ‘ä»¬ä»ç´¢å¼• 1 å¼€å§‹èµ° (ç´¢å¼•0æ˜¯å½“å‰ä½ç½®)
            for (let i = 1; i < path.length; i++) {
                const nextStep = path[i];
                updateHunterVis(nextStep);
                sfx('step');
                await wait(400); // èµ°è·¯é€Ÿåº¦
            }
        }

        function updateHunterVis(idx) {
            hunterPos = idx;
            const hunter = document.getElementById('hunter');
            const cell = document.getElementById(`cell-${idx}`);
            // è®¡ç®—ç›¸å¯¹ä½ç½®: cellçš„offset + cellå®½é«˜ä¸€åŠ - hunterå®½é«˜ä¸€åŠ
            // è¿™é‡Œå› ä¸º grid æ˜¯ relative, æˆ‘ä»¬å¯ä»¥ç›´æ¥å– cell çš„ offsetLeft/Top
            const left = cell.offsetLeft + cell.offsetWidth/2 - 20;
            const top = cell.offsetTop + cell.offsetHeight/2 - 20;
            hunter.style.left = left + 'px';
            hunter.style.top = top + 'px';
            
            // æ‰«å…‰æ•ˆæœ
            document.querySelectorAll('.room-cell').forEach(c=>c.classList.remove('target-lock'));
            cell.classList.add('target-lock');
        }

        function log(msg) {
            document.getElementById('consoleText').innerText = msg;
        }

        function showMapWinner() {
            const survivors = [];
            // æ‰¾å‡ºä¸åœ¨ outSequence çš„äºº
            currentGame.players.forEach((p,i) => {
                if(!currentGame.outSequence.includes(i)) survivors.push(p);
            });
            
            sfx('win');
            document.getElementById('winScreen').style.display = 'flex';
            document.getElementById('wName').innerText = survivors.join(" & ");
            document.getElementById('wPrize').innerText = currentGame.prize;
        }

        // --- æ—§ç‰ˆè½¬ç›˜å…¼å®¹ (ç®€æ˜“è‡ªåŠ¨ç‰ˆ) ---
        async function playWheelSequence() {
            document.getElementById('startBtn').classList.add('hidden');
            const strip = document.getElementById('wheelStrip');
            const alive = currentGame.players.map((_,i)=>i);

            for (let i=0; i<currentGame.outSequence.length; i++) {
                const victim = currentGame.outSequence[i];
                log("Rolling...");
                
                strip.innerHTML = ''; strip.style.transition='none'; strip.style.transform='translateX(0)';
                // é€ å‡æ¡
                for(let j=0; j<20; j++) {
                    let pid = (j===15) ? victim : alive[Math.floor(Math.random()*alive.length)];
                    let div = document.createElement('div'); div.className='wheel-item'; div.innerText = currentGame.players[pid];
                    strip.appendChild(div);
                }
                await wait(50);
                strip.style.transition='transform 2s';
                strip.style.transform = `translateX(-${15*90 - 150}px)`;
                await wait(2000);
                sfx('kill');
                alive.splice(alive.indexOf(victim), 1);
                await wait(1000);
            }
            
            document.getElementById('winScreen').style.display = 'flex';
            document.getElementById('wName').innerText = currentGame.players[currentGame.winnerIdx];
        }

    </script>
</body>
</html>
