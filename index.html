<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å“ˆåŸºè‚‰çš„é¥°å“å¤§é€ƒæ€ | æ’­æ”¾å™¨</title>
    <script src="data.js"></script>
    <style>
        /* --- æ ¸å¿ƒæ ·å¼ --- */
        :root { --bg: #141414; --gold: #eebc51; --red: #d32f2f; --text: #e0e0e0; }
        body { background-color: var(--bg); background-image: radial-gradient(circle at 50% 0, #2a2a30 0%, #141414 70%); color: var(--text); font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        
        .header { text-align: center; margin-bottom: 20px; width: 100%;}
        h1 { margin: 0; font-size: 26px; font-style: italic; text-transform: uppercase; background: linear-gradient(180deg, #fff 0%, #bbb 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { color: var(--gold); font-size: 11px; letter-spacing: 2px; margin-top: 5px; opacity: 0.8; }

        .cta-container { width: 100%; text-align: center; margin-bottom: 25px; }
        .cta-btn { display: inline-block; background: linear-gradient(90deg, #de9b35 0%, #f0c05a 100%); color: #1a1a1a; text-decoration: none; padding: 12px 30px; border-radius: 50px; font-weight: bold; font-size: 15px; box-shadow: 0 0 20px rgba(222, 155, 53, 0.4); border: 1px solid #fff; }
        .cta-btn:active { transform: scale(0.96); }

        .history-list { width: 100%; max-width: 500px; padding-bottom: 100px; }
        .match-card { background: rgba(30, 30, 30, 0.6); border: 1px solid #333; border-left: 3px solid #555; margin-bottom: 10px; padding: 12px 15px; display: flex; align-items: center; cursor: pointer; transition: 0.2s; border-radius: 4px; }
        .match-card:active { transform: scale(0.98); background: #252525; }
        .match-card .info { font-size: 14px; color: #fff; font-weight: bold; }
        .match-card .prize-tag { font-size: 11px; color: var(--gold); margin-top: 4px; text-transform: uppercase; }

        /* --- å¼¹çª—ä¸æ’­æ”¾å™¨ --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; flex-direction: column; align-items: center; justify-content: center; }
        .status-bar { text-align: center; margin-bottom: 20px; width: 100%; min-height: 50px;}
        .action-text { font-size: 20px; font-weight: bold; color: #fff; transition: 0.3s;}

        /* --- è½¬ç›˜æ ·å¼ (æ—§æ¨¡å¼) --- */
        .case-container { width: 100%; height: 150px; background: #0b0b0b; position: relative; border-top: 2px solid var(--gold); border-bottom: 2px solid var(--gold); margin-bottom: 30px; overflow: hidden; display: none; }
        .pointer { position: absolute; left: 50%; top: 0; bottom: 0; width: 2px; background: var(--gold); z-index: 10; transform: translateX(-50%); box-shadow: 0 0 10px var(--gold); }
        .strip { display: flex; height: 100%; align-items: center; position: absolute; left: 50%; will-change: transform; }
        .item { width: 90px; height: 110px; background: #222; border-bottom: 4px solid #fff; margin: 0 3px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .item.eliminated { filter: grayscale(100%) brightness(0.4); background: #220505; border-bottom-color: var(--red) !important; }

        /* --- ğŸ° åœ°å›¾æ ·å¼ (æ–°æ¨¡å¼) --- */
        .map-container { display: none; width: 100%; max-width: 380px; margin-bottom: 20px; }
        .mansion-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; padding: 10px; background: #1a1a1a; border: 4px solid #333; border-radius: 8px; position: relative; }
        .room-cell { background: #2a2a2a; border: 1px solid #444; border-radius: 4px; min-height: 80px; padding: 4px; position: relative; display: flex; flex-direction: column; align-items: center; }
        .room-cell.blood-bath { background: #420b0b !important; border-color: #d32f2f; animation: shake 0.4s; }
        .room-number { font-size: 10px; color: #555; position: absolute; top: 2px; left: 4px; }
        
        .player-token { font-size: 10px; color: #fff; background: #000; padding: 2px 4px; border-radius: 3px; margin: 2px 0; width: 95%; text-align: center; border-left: 2px solid var(--gold); overflow: hidden; white-space: nowrap; text-overflow: ellipsis;}
        .player-token.dead { text-decoration: line-through; color: #666; border-left-color: #444; opacity: 0.5; }

        .hunter-piece { position: absolute; width: 50px; height: 50px; font-size: 36px; display: flex; align-items: center; justify-content: center; z-index: 50; transition: top 0.5s, left 0.5s; filter: drop-shadow(0 0 5px #f00); pointer-events: none; }

        /* --- æŒ‰é’® --- */
        .fire-btn { background: linear-gradient(180deg, #d32f2f 0%, #8a1c1c 100%); border: 2px solid #ff5c5c; color: #fff; width: 120px; height: 120px; border-radius: 50%; font-size: 20px; font-weight: bold; box-shadow: 0 0 30px rgba(211, 47, 47, 0.5); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.1s; animation: pulse 2s infinite; }
        .fire-btn:active { transform: scale(0.95); }
        .fire-btn.disabled { background: #333; border-color: #555; color: #777; pointer-events: none; animation: none; box-shadow: none; }
        .fire-btn span { font-size: 10px; font-weight: normal; margin-top: 5px; opacity: 0.8; }

        /* --- ç»“ç®— --- */
        .winner-modal { display: none; flex-direction: column; align-items: center; animation: zoomIn 0.4s; width: 100%; }
        .win-card { width: 220px; padding: 20px; background: radial-gradient(circle, #4a3b18 0%, #1a1a1a 100%); border: 2px solid var(--gold); border-radius: 8px; text-align: center; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 25% { transform: translate(-2px, 0px); } 50% { transform: translate(1px, -1px); } 75% { transform: translate(-2px, 1px); } 100% { transform: translate(0, 0); } }
    </style>
</head>
<body>

    <div class="header">
        <h1>å“ˆåŸºè‚‰çš„é¥°å“å¤§é€ƒæ€</h1>
        <div class="subtitle">ç‚¹å‡»ä¸‹æ–¹åˆ—è¡¨æŸ¥çœ‹å›æ”¾</div>
    </div>

    <div class="cta-container">
        <a href="https://casego.cn/home?Code=HSR91" target="_blank" class="cta-btn">
            ğŸŸï¸ å‰å¾€ Casego å‚ä¸
        </a>
    </div>

    <div class="history-list" id="listArea"></div>

    <div class="modal" id="gameModal">
        <div class="status-bar">
            <div style="font-size:12px; color:#666; margin-bottom:5px" id="roundTag">READY</div>
            <div class="action-text" id="statusText">ç­‰å¾…æŒ‡ä»¤...</div>
        </div>

        <!-- è½¬ç›˜å®¹å™¨ -->
        <div class="case-container"><div class="pointer"></div><div class="strip" id="strip"></div></div>

        <!-- åœ°å›¾å®¹å™¨ -->
        <div class="map-container" id="mapArea">
            <div class="mansion-grid" id="mansionGrid">
                <div class="hunter-piece" id="hunter" style="display:none">ğŸ‘¹</div>
            </div>
        </div>
        
        <button class="fire-btn" id="fireBtn" onclick="nextRound()">
            FIRE
            <span>æ’­æ”¾ä¸‹ä¸€å¹•</span>
        </button>

        <div class="winner-modal" id="winnerArea">
            <div class="win-card">
                <div class="crown" style="font-size:40px">ğŸ‘‘</div>
                <div id="winTitle" style="font-size:12px;color:#888;margin-bottom:5px">WINNER</div>
                <div class="player-name" id="winName" style="color:#fff;font-size:18px;font-weight:bold;margin-bottom:15px"></div>
                <div style="font-size:12px;color:#888">REWARD</div>
                <div style="color:var(--gold);font-weight:bold" id="winPrize"></div>
            </div>
            <button onclick="document.getElementById('gameModal').style.display='none'" style="margin-top:20px;background:none;border:1px solid #555;color:#888;padding:8px 30px;border-radius:20px;cursor:pointer">å…³é—­</button>
        </div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            if(type==='click'){
                osc.type='triangle'; osc.frequency.setValueAtTime(800,t); osc.frequency.exponentialRampToValueAtTime(100,t+0.05);
                gain.gain.setValueAtTime(0.3,t); gain.gain.exponentialRampToValueAtTime(0.01,t+0.05);
                osc.start(t); osc.stop(t+0.06);
            } else if(type==='thud'){
                osc.type='square'; osc.frequency.setValueAtTime(150,t); osc.frequency.exponentialRampToValueAtTime(0.01,t+0.3);
                gain.gain.setValueAtTime(0.5,t); gain.gain.exponentialRampToValueAtTime(0.01,t+0.3);
                const f=audioCtx.createBiquadFilter(); f.type="lowpass"; f.frequency.value=200;
                osc.connect(f); f.connect(gain); osc.start(t); osc.stop(t+0.3); return;
            } else if(type==='win'){
                osc.type='sine'; osc.frequency.value=523.25; gain.gain.setValueAtTime(0.1,t); gain.gain.exponentialRampToValueAtTime(0.01,t+0.6);
                osc.start(t); osc.stop(t+0.6);
            }
            osc.connect(gain); gain.connect(audioCtx.destination);
        }
        function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }

        // --- é€»è¾‘éƒ¨åˆ† ---
        const listArea = document.getElementById('listArea');
        let currentGame=null; let currentRound=0; let currentAliveIndices=[]; let isSpinning=false;
        let hunterRoomIdx = -1; // åœ°å›¾æ¨¡å¼ä¸“ç”¨

        // æ¸²æŸ“åˆ—è¡¨
        function renderList() {
            listArea.innerHTML = '';
            // é¢„å‘Š
            if (typeof teaser !== 'undefined' && teaser && teaser.active) {
                listArea.innerHTML += `<div style="background:#222;border:1px dashed var(--gold);padding:10px;text-align:center;margin-bottom:10px;border-radius:4px"><div style="color:var(--gold);font-size:10px">NEXT</div><div>${teaser.id}</div></div>`;
            }
            if (typeof gameHistory !== 'undefined') {
                gameHistory.slice().reverse().forEach(game => {
                    const div = document.createElement('div');
                    div.className = 'match-card';
                    div.onclick = () => loadGame(game);
                    
                    // åˆ¤æ–­èµ¢å®¶æ˜¾ç¤º
                    let winnerText = "???";
                    if(game.winnerIdx !== undefined) winnerText = game.players[game.winnerIdx];
                    // å¦‚æœæ˜¯åœ°å›¾æ¨¡å¼ï¼Œèµ¢å®¶å¯èƒ½æ˜¯å‰©ä¸‹çš„2ä¸ªäººï¼Œè¿™é‡Œç®€å•å¤„ç†ï¼Œå›æ”¾æ—¶ä¼šæ˜¾ç¤ºå¯¹
                    if(game.type === 'map' && !game.winnerIdx && game.outSequence) {
                         // åœ°å›¾æ¨¡å¼å†å²åˆ—è¡¨é‡Œå°±ä¸æ˜¾ç¤ºèµ¢å®¶äº†ï¼Œç•™ç‚¹æ‚¬å¿µï¼Œæˆ–è€…ç®€å•æ˜¾ç¤º"åŒäººå¹¸å­˜"
                         winnerText = "åŒäººå¹¸å­˜";
                    }

                    div.innerHTML = `<div style="flex:1"><div class="info">${game.id} ${game.type==='map'?'ğŸ‘¹':''}</div><div class="prize-tag">ğŸ“¦ ${game.prize}</div></div><div style="font-size:12px;color:#666">${winnerText}</div>`;
                    listArea.appendChild(div);
                });
            }
        }
        renderList();

        function loadGame(game) {
            currentGame = game;
            currentRound = 0;
            currentAliveIndices = game.players.map((_, i) => i);
            isSpinning = false;
            
            document.getElementById('gameModal').style.display='flex';
            document.getElementById('winnerArea').style.display='none';
            document.getElementById('fireBtn').style.display='flex';
            
            enableBtn(true, "START");
            document.getElementById('roundTag').innerText = "READY";
            document.getElementById('statusText').innerText = "ç­‰å¾…å¼€å§‹...";

            // åˆ‡æ¢æ¨¡å¼
            if (game.type === 'map') {
                document.querySelector('.case-container').style.display = 'none';
                document.getElementById('mapArea').style.display = 'block';
                initMap(game);
            } else {
                document.getElementById('mapArea').style.display = 'none';
                document.querySelector('.case-container').style.display = 'block';
                initWheel(game);
            }
        }

        function nextRound() {
            if(isSpinning) return;
            if(currentRound >= currentGame.outSequence.length) {
                showWinner();
                return;
            }

            if(currentGame.type === 'map') playMapRound();
            else playWheelRound();
        }

        // --- ğŸ‘¹ åœ°å›¾æ¨¡å¼é€»è¾‘ ---
        function initMap(game) {
            const grid = document.getElementById('mansionGrid');
            const hunter = document.getElementById('hunter');
            grid.innerHTML = ''; grid.appendChild(hunter);
            hunter.style.display = 'none'; hunterRoomIdx = -1;

            // åˆ›å»º9ä¸ªæˆ¿é—´
            for(let i=0; i<9; i++) {
                const cell = document.createElement('div');
                cell.className = 'room-cell';
                cell.id = `room-${i}`;
                cell.innerHTML = `<div class="room-number">${i+101}</div>`;
                
                // æ”¾å…¥ç©å®¶
                game.players.forEach((name, pIdx) => {
                    if (game.rooms[pIdx] === i) {
                        const tk = document.createElement('div');
                        tk.className = 'player-token';
                        tk.id = `token-${pIdx}`;
                        tk.innerText = name;
                        cell.appendChild(tk);
                    }
                });
                grid.appendChild(cell);
            }
            document.getElementById('roundTag').innerText = `SURVIVORS: ${currentAliveIndices.length}`;
        }

        async function playMapRound() {
            isSpinning = true;
            enableBtn(false, "HUNTING");
            document.getElementById('statusText').innerText = "å± å¤«æ­£åœ¨æ¥è¿‘...";

            const victimIdx = currentGame.outSequence[currentRound];
            const victimRoom = currentGame.rooms[victimIdx];
            const victimName = currentGame.players[victimIdx];

            // 1. ç§»åŠ¨å± å¤«
            const hunter = document.getElementById('hunter');
            hunter.style.display = 'flex';
            const cell = document.getElementById(`room-${victimRoom}`);
            
            // ç®€å•å®šä½
            const cellRect = cell.getBoundingClientRect(); // ç›¸å¯¹è§†å£ï¼Œè¿™é‡Œç”¨offsetParentå®šä½æ›´å‡†
            // åœ¨gridå†…çš„ç›¸å¯¹å®šä½
            hunter.style.top = (cell.offsetTop + cell.offsetHeight/2 - 25) + 'px';
            hunter.style.left = (cell.offsetLeft + cell.offsetWidth/2 - 25) + 'px';
            
            playSound('click');
            await wait(800);

            // 2. æ€æˆ®
            playSound('thud');
            cell.classList.add('blood-bath');
            const token = document.getElementById(`token-${victimIdx}`);
            if(token) token.classList.add('dead');
            
            document.getElementById('statusText').innerText = `ğŸ˜± ${victimName} é‡å®³!`;
            if(navigator.vibrate) navigator.vibrate(200);

            currentAliveIndices = currentAliveIndices.filter(i => i !== victimIdx);
            currentRound++;
            document.getElementById('roundTag').innerText = `SURVIVORS: ${currentAliveIndices.length}`;

            await wait(1000);
            cell.classList.remove('blood-bath');
            isSpinning = false;

            if(currentRound >= currentGame.outSequence.length) showWinner();
            else enableBtn(true, "NEXT KILL");
        }

        // --- ğŸ¡ è½¬ç›˜æ¨¡å¼é€»è¾‘ (ä¿ç•™æ—§åŠŸèƒ½) ---
        function initWheel(game) {
            const strip = document.getElementById('strip');
            strip.innerHTML=''; strip.style.transform='translateX(0)';
            for(let i=0; i<5; i++) strip.appendChild(createItem(i, game.players[i]));
        }

        async function playWheelRound() {
            // ... (çœç•¥éƒ¨åˆ†ä»£ç ï¼Œä¸ä¹‹å‰ç›¸åŒï¼Œä¿ç•™åŸºæœ¬æ’­æ”¾åŠŸèƒ½)
            // ä¸ºäº†ä»£ç ç®€æ´ï¼Œè¿™é‡Œç•¥å†™ï¼Œé€»è¾‘åŒä¹‹å‰ç‰ˆæœ¬
            isSpinning=true; enableBtn(false,"ROLLING");
            const strip = document.getElementById('strip');
            const victimIdx = currentGame.outSequence[currentRound];
            
            strip.innerHTML=''; strip.style.transition='none'; strip.style.transform='translateX(0)';
            for(let i=0; i<40; i++) {
                let pid = (i===30)?victimIdx : currentAliveIndices[Math.floor(Math.random()*currentAliveIndices.length)];
                strip.appendChild(createItem(pid, currentGame.players[pid]));
            }
            await wait(50);
            strip.style.transition = 'transform 3s cubic-bezier(0.1,0,0.2,1)';
            strip.style.transform = `translateX(-${30*96 - 150}px)`;
            
            await wait(3000);
            playSound('thud');
            currentAliveIndices = currentAliveIndices.filter(i=>i!==victimIdx);
            currentRound++;
            isSpinning=false;
            if(currentRound >= currentGame.outSequence.length) showWinner();
            else enableBtn(true, "FIRE");
        }

        function createItem(idx, name){
            const d=document.createElement('div'); d.className='item';
            d.innerHTML=`<div style="font-size:24px">ğŸ‘¤</div><div style="font-size:10px;text-align:center;width:90%;overflow:hidden">${name}</div>`;
            return d;
        }

        // --- ç»“ç®— ---
        function showWinner() {
            document.querySelector('.case-container').style.display='none';
            document.getElementById('mapArea').style.display='none';
            document.getElementById('fireBtn').style.display='none';
            document.getElementById('winnerArea').style.display='flex';
            playSound('win');

            const survivors = currentAliveIndices.map(i => currentGame.players[i]);
            
            if (currentGame.type === 'map') {
                document.querySelector('.crown').innerText = "ğŸ¤";
                document.getElementById('winTitle').innerText = "SURVIVORS (SPLIT)";
                document.getElementById('winName').innerText = survivors.join(" & ");
            } else {
                document.querySelector('.crown').innerText = "ğŸ‘‘";
                document.getElementById('winTitle').innerText = "WINNER";
                document.getElementById('winName').innerText = survivors[0];
            }
            document.getElementById('winPrize').innerText = currentGame.prize;
        }

        function enableBtn(on, txt){
            const b=document.getElementById('fireBtn');
            if(on){ b.classList.remove('disabled'); b.querySelector('span').innerText=txt; }
            else { b.classList.add('disabled'); b.querySelector('span').innerText="..."; }
        }
    </script>
</body>
</html>
